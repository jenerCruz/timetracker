<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker PWA - Profesional</title>
    <!-- Carga de Tailwind CSS -->
    <link href="./src/output.css" rel="stylesheet">
    <!-- Carga de Lucide Icons (Iconos modernos) -->
    <script src="./assets/js/lucide.min.js"></script>
    <style>
        /* Estilos personalizados para un look sofisticado */
        :root {
            --primary-color: #1e3a8a; /* Indigo 800 */
            --accent-color: #3b82f6;  /* Blue 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Light Gray background */
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
        }
        .nav-icon {
            transition: color 0.2s, transform 0.2s;
        }
        .nav-icon.active {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        /* Estilo tipo card Bootstrap */
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        /* Animación para el botón principal de Clock In/Out */
        .clock-button {
            transition: all 0.3s ease;
        }
        .clock-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgba(59, 130, 246, 0.4);
        }
        /* Estilo para los inputs */
        input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="app-container max-w-4xl mx-auto shadow-2xl bg-white">
        <!-- Encabezado Fijo -->
        <header class="p-4 border-b bg-white sticky top-0 z-10">
            <h1 class="text-2xl font-extrabold text-gray-800 flex items-center">
                <i data-lucide="clock" class="w-6 h-6 mr-2 text-indigo-700"></i>
                Time Tracker Pro
            </h1>
            <p id="user-id-display" class="text-xs mt-1 text-gray-500 truncate">ID de Usuario: Cargando...</p>
        </header>

        <!-- Contenido Principal Dinámico -->
        <main id="content-area" class="main-content p-4 sm:p-6 pb-20 overflow-y-auto">
            <!-- El contenido de la vista activa se inyectará aquí -->
            <div class="text-center py-10 text-gray-500">
                <i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin"></i>
                <p class="mt-2">Cargando aplicación...</p>
            </div>
        </main>

        <!-- Navegación Fija Inferior (Mobile-First) -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl z-20 sm:hidden">
            <div class="flex justify-around items-center h-16">
                <button onclick="showView('dashboard')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 nav-icon active" data-view="dashboard"></i>
                    <span class="text-xs mt-1 font-medium">Inicio</span>
                </button>
                <button onclick="showView('track')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="clock-3" class="w-6 h-6 nav-icon" data-view="track"></i>
                    <span class="text-xs mt-1 font-medium">Registro</span>
                </button>
                <button
onclick="showView('reports')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 nav-icon" data-view="reports"></i>
                    <span class="text-xs mt-1 font-medium">Reportes</span>
                </button>
                <button onclick="showView('setup')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="settings" class="w-6 h-6 nav-icon" data-view="setup"></i>
                    <span class="text-xs mt-1 font-medium">Ajustes</span>
                </button>
            </div>
        </nav>

        <!-- Contenedor de Mensajes Modales/Notificaciones -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <!-- El modal se inyectará aquí -->
        </div>

    </div>

    <!-- Firebase Imports for Context -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('error'); // Setting log level

        let auth, userId;

        /**
         * Inicializa Firebase y autentica al usuario.
         * Se usa para obtener un ID de usuario único (UID) para el contexto de la aplicación,
         * especialmente útil para la sincronización.
         */
        async function initFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Proceeding with anonymous ID.");
                    // Fallback: use a static/random ID if no Firebase config is provided.
                    window.userId = 'anon-' + (localStorage.getItem('anonId') || crypto.randomUUID());
                    localStorage.setItem('anonId', window.userId);
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                window.userId = userId; // Asigna a la ventana para acceso global
                console.log("Firebase Auth successful. User ID:", userId);

                // Muestra el ID de usuario en la UI
                document.getElementById('user-id-display').textContent = `ID de Usuario: ${userId}`;
            } catch (error) {
                console.error("Firebase/Auth initialization failed:", error);
                // Fallback: use a random ID if auth fails
                window.userId = 'auth-fail-' + crypto.randomUUID();
            } finally {
                // Una vez que el userId está establecido, inicializa la aplicación principal
                window.initApp();
            }
        }

        initFirebaseAndAuth();

    </script>

    <script>
        // =========================================================================
        // Configuración Global y Utilidades
        // =========================================================================
         const DB_NAME = 'TimeTrackerDB';
        const DB_VERSION = 1;
        
        // --- SUSTITUCIÓN DE ID DE USUARIO (SIN FIREBASE) ---
        // Generación de un ID de usuario persistente (sustituto de Firebase UID)
        window.userId = 'anon-' + (localStorage.getItem('anonId') || crypto.randomUUID());
        localStorage.setItem('anonId', window.userId);
        document.getElementById('user-id-display').textContent = `ID de Usuario: ${window.userId.substring(0, 10)}... (Local)`;

        // ... (Mantener showMessage, hideMessage, deg2rad, getDistance, formatHours, sleep)

        /**
         * Muestra un mensaje modal de forma segura (reemplazando window.alert/confirm).
         * @param {string} message Mensaje a mostrar.
         * @param {string} type Tipo de mensaje (info, error, success).
         */
        function showMessage(message, type = 'info') {
            const container = document.getElementById('modal-container');
            let bgColor = 'bg-blue-600';
            let icon = 'info';

            if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = 'alert-triangle';
            } else if (type === 'success') {
                bgColor = 'bg-green-600';
                icon = 'check-circle';
            }

            const modalHtml = `
                <div class="card p-6 w-full max-w-sm mx-auto transform transition-all scale-100 duration-300">
                    <div class="flex items-center space-x-4">
                        <i data-lucide="${icon}" class="w-6 h-6 text-white ${bgColor} rounded-full p-1 flex-shrink-0"></i>
                        <p class="text-gray-700 font-semibold flex-grow">${message}</p>
                    </div>
                    <div class="mt-4 text-right">
                        <button onclick="hideMessage()" class="px-4 py-2 text-sm font-medium rounded-lg text-white ${bgColor} hover:opacity-90">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = modalHtml;
            container.classList.remove('hidden');
            container.classList.add('flex');
            lucide.createIcons(); // Vuelve a renderizar iconos

            setTimeout(hideMessage, 5000); // Cierre automático
        }

        /** Oculta el modal de mensajes. */
        function hideMessage() {
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-container').classList.remove('flex');
        }

        /**
         * Convierte coordenadas de grados a radianes.
         * @param {number} deg Grados.
         * @returns {number} Radianes.
         */
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        /**
         * Calcula la distancia entre dos puntos geográficos (Lat/Lng) usando la fórmula de Haversine.
         * @param {number} lat1 Latitud 1.
         * @param {number} lon1 Longitud 1.
         * @param {number} lat2 Latitud 2.
         * @param {number} lon2 Longitud 2.
         * @returns {number} Distancia en metros.
        */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distancia en metros
        } /**
         * Formatea un número en horas y minutos (ej: 1.5 -> 1h 30m).
         * @param {number} hours Horas totales (decimal).
         * @returns {string} Cadena formateada.
         */
        function formatHours(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${h}h ${m}m`;
        }

        /**
         * Retraso para reintentos en Gist (Backoff exponencial).
         * @param {number} ms Milisegundos a esperar.
         * @returns {Promise}
         */
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        // =========================================================================
        // DEXIE MANAGER (Sustituto de IndexedDB)
        // =========================================================================
        let db; // Variable global para la conexión a Dexie
        const STORES = ['branches', 'employees', 'timeEntries']; // Usado solo para serializar/deserializar en Gist

        /**
         * Inicializa la base de datos con Dexie.
         */
        function initDB() {
            return new Promise((resolve, reject) => {
                try {
                    db = new Dexie(DB_NAME);
                    // Definición de las tablas (stores) con clave primaria auto-incremental '++id'
                    db.version(DB_VERSION).stores({
                        branches: '++id, name',
                        employees: '++id, branchId',
                        timeEntries: '++id, employeeId, clockIn'
                    });

                    db.open()
                        .then(() => {
                            console.log("Dexie (IndexedDB) inicializada con éxito.");
                            resolve(db);
                        })
                        .catch(err => {
                            console.error("Error al abrir Dexie:", err);
                            showMessage(`Error de base de datos: ${err.message}`, 'error');
                            reject(err);
                        });
                } catch (e) {
                    reject(e);
                }
            });
        }

        /**
         * Obtiene todos los objetos de un almacén.
         * @param {string} storeName
         * @returns {Promise<Array<Object>>}
         */
        async function getAll(storeName) {
            return db.table(storeName).toArray();
        }

        /**
         * Agrega o actualiza un objeto (usa 'id' como clave si existe).
         * @param {string} storeName
         * @param {Object} item
         * @returns {Promise<number>} ID de la clave insertada/actualizada.
         */
        async function put(storeName, item) {
            return db.table(storeName).put(item);
        }

        /**
         * Obtiene un objeto por su ID.
         * @param {string} storeName
         * @param {number|string} id
         * @returns {Promise<Object|undefined>}
         */
        async function get(storeName, id) {
            // Dexie maneja la conversión de tipo si la clave primaria lo permite
            return db.table(storeName).get(parseInt(id));
        }/**
         * Elimina un objeto por su ID.
         * @param {string} storeName
         * @param {number|string} id
         * @returns {Promise<void>}
         */
        async function remove(storeName, id) {
            // Aseguramos que el id sea numérico
            return db.table(storeName).delete(parseInt(id));
        }

        /**
         * Limpia un almacén.
         * @param {string} storeName
         * @returns {Promise<void>}
         */
        async function clearStore(storeName) {
            return db.table(storeName).clear();
        }


        // =========================================================================
        // Geolocation Logic (Mantenida)
        // =========================================================================

        /**
         * Obtiene la ubicación actual del dispositivo.
         * @returns {Promise<{lat: number, lng: number}>}
         */
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocalización no soportada por este navegador."));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        console.error("Error de geolocalización:", error);
                        reject(new Error(`Error de ubicación (${error.code}): ${error.message}`));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }


        // =========================================================================
        // Gist Synchronization Logic (Mantenida, usa las nuevas funciones de Dexie)
        // =========================================================================

        const GIST_API_BASE = 'https://api.github.com/gists';

        /**
         * Serializa todos los datos de Dexie a un objeto JSON.
         * @returns {Promise<Object>} Datos serializados.
         */
        async function serializeData() {
            const data = {};
            for (const storeName of STORES) {
                data[storeName] = await getAll(storeName);
            }
            data.metadata = {
                timestamp: Date.now(),
                userId: window.userId
            };
            return data;
        }

        /**
         * Exporta los datos a un GitHub Gist.
         * @param {string} token Token de acceso personal de GitHub.
         * @param {string} gistId ID del Gist existente (o null para crear uno nuevo).
         * @returns {Promise<string>} El ID del Gist creado/actualizado.
         */
        async function exportToGist(token, gistId) {
            const data = await serializeData();
            const fileName = `time_tracker_data_${window.userId}.json`;

            const payload = {
                description: `Time Tracker PWA Data - User ${window.userId}`,
                public: false,
                files: {
                    [fileName]: {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };

            const url = gistId ? `${GIST_API_BASE}/${gistId}` : GIST_API_BASE;
            const method = gistId ? 'PATCH' : 'POST';

            let attempt = 0;
            const maxRetries = 3;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`GitHub API Error (${response.status}): ${errorBody.message || 'Error desconocido'}`);
                    }

                    const result = await response.json();
                    return result.id;

                } catch (error) {
                    console.warn(`Intento ${attempt + 1} fallido. Reintentando...`, error.message);
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await sleep(1000 * Math.pow(2, attempt)); // Exponential backoff
                }
            }
        }
   /**
         * Importa datos desde un GitHub Gist y sobrescribe Dexie.
         * @param {string} token Token de acceso personal de GitHub.
         * @param {string} gistId ID del Gist.
         * @returns {Promise<void>}
         */
        async function importFromGist(token, gistId) {
            const url = `${GIST_API_BASE}/${gistId}`;
            const maxRetries = 3;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`GitHub API Error (${response.status}): ${errorBody.message || 'Error desconocido'}`);
                    }

                    const gist = await response.json();
                    const fileName = Object.keys(gist.files).find(name => name.startsWith('time_tracker_data_'));

                    if (!fileName) {
                        throw new Error("No se encontró el archivo de datos del Time Tracker en el Gist.");
                    }

                    const dataContent = JSON.parse(gist.files[fileName].content);

                    // 1. Limpiar todos los almacenes
                    for (const storeName of STORES) {
                        await clearStore(storeName);
                    }

                    // 2. Insertar los nuevos datos
                    for (const storeName of STORES) {
                        if (dataContent[storeName]) {
                            // Dexie permite un bulkAdd o put
                            await db.table(storeName).bulkPut(dataContent[storeName]);
                        }
                    }
                    return; // Éxito

                } catch (error) {
                    console.warn(`Intento ${attempt + 1} fallido. Reintentando...`, error.message);
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await sleep(1000 * Math.pow(2, attempt)); // Exponential backoff
                }
            }
        }
// =========================================================================
        // Aplicación Principal y Renderizado
        // =========================================================================
        let currentView = 'dashboard';
        let branchList = [];
        let employeeList = [];

        /**
         * Cambia la vista activa y actualiza los íconos de navegación.
         * FIX: Corrige el flujo para asegurar la inicialización de listeners.
         * @param {string} viewName Nombre de la vista.
         */
        function showView(viewName) {
            currentView = viewName;
            const contentArea = document.getElementById('content-area');

            // 1. Renderiza la vista (obtiene HTML o placeholder)
            const renderResult = renderView(viewName);
            
            // Si renderView devuelve HTML directamente, lo insertamos
            if (typeof renderResult === 'string') {
                contentArea.innerHTML = renderResult;
                lucide.createIcons();
            }

            // 2. Ejecuta listeners específicos después del renderizado si es necesario
            if (viewName === 'setup') {
                // FIX: Llama directamente a la inicialización de listeners para el formulario
                // Se usa setTimeout para asegurar que el DOM se haya actualizado.
                setTimeout(setupFormListeners, 50); 
            }

            // 3. Actualiza navegación
            updateNavIcons(viewName);
        }

        /**
         * Actualiza el estado visual de los íconos de navegación.
         * @param {string} activeView
         */
        function updateNavIcons(activeView) {
            document.querySelectorAll('.nav-icon').forEach(icon => {
                if (icon.getAttribute('data-view') === activeView) {
                    icon.classList.add('active', 'text-blue-600');
                    icon.classList.remove('text-gray-500');
                } else {
                    icon.classList.remove('active', 'text-blue-600');
                    icon.classList.add('text-gray-500');
                }
            });
        }

        /**
         * Función central para renderizar la vista.
         * @param {string} viewName
         * @returns {string} HTML de la vista (o placeholder si es asíncrona).
         */
        function renderView(viewName) {
            switch (viewName) {
                case 'dashboard':
                    return renderDashboard();
                case 'track':
                    // Se usa .then para que el renderizado final se haga después de la carga de datos.
                    loadTrackData().then(renderTrackView).catch(console.error);
                    return `<div class="text-center py-10 text-gray-500"><i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin"></i><p class="mt-2">Preparando vista de registro...</p></div>`;
                case 'reports':
                    loadReportData().then(renderReportsView).catch(console.error);
                    return `<div class="text-center py-10 text-gray-500"><i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin"></i><p class="mt-2">Generando reportes...</p></div>`;
                case 'setup':
                    return renderSetup();
                default:
                    return renderDashboard();
            }
        }
// ======================== RENDER VISTAS ESPECÍFICAS (Mantenidas) ========================

        /** Renderiza la vista de Inicio/Dashboard. */
        function renderDashboard() {
            // Placeholder para un dashboard más complejo.
            return `
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Bienvenido al Time Tracker</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-5 bg-indigo-50 border-l-4 border-indigo-500">
                        <div class="flex items-center">
                            <i data-lucide="users" class="w-8 h-8 text-indigo-500 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Empleados Registrados</p>
                                <p class="text-2xl font-bold text-gray-900">${employeeList.length}</p>
                            </div>
                        </div>
                        <button onclick="showView('setup')" class="mt-3 text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                            Administrar <i data-lucide="arrow-right" class="w-4 h-4 inline ml-1"></i>
                        </button>
                    </div>

                    <div class="card p-5 bg-green-50 border-l-4 border-green-500">
                        <div class="flex items-center">
                            <i data-lucide="map-pin" class="w-8 h-8 text-green-500 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Sucursales Activas</p>
                                <p class="text-2xl font-bold text-gray-900">${branchList.length}</p>
                            </div>
                        </div>
                         <button onclick="showView('setup')" class="mt-3 text-green-600 hover:text-green-800 text-sm font-medium">
                            Configurar <i data-lucide="arrow-right" class="w-4 h-4 inline ml-1"></i>
                        </button>
                    </div>

                    <div class="md:col-span-2 card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Estado Reciente</h3>
                        <p class="text-gray-500">Aquí se mostrarán los datos resumidos y el último estado de registro de un empleado.</p>
                        <p class="mt-3 text-sm text-gray-600">Para estadísticas detalladas, visita la sección de Reportes.</p>
                    </div>
                </div>
            `;
        }

        /** Carga datos necesarios para la vista de Registro de Tiempo. */
        async function loadTrackData() {
            try {
                branchList = await getAll('branches');
                employeeList = await getAll('employees');
            } catch (error) {
                showMessage("Error al cargar datos de Sucursales/Empleados.", 'error');
                console.error(error);
            }
        }

        /** Renderiza la vista de Registro de Tiempo. */
        function renderTrackView() {
            const contentArea = document.getElementById('content-area');

            if (employeeList.length === 0) {
                 contentArea.innerHTML = `<div class="p-6 text-center card bg-yellow-100 border-yellow-400 border"><p class="font-semibold text-yellow-800">No hay empleados registrados. Por favor, agregue perfiles en la sección Ajustes.</p></div>`;
                 return;
            }

            // Encuentra la última entrada del usuario actual (simulación simple)
            // En una app real, buscarías el último registro de CADA empleado. Aquí asumimos un solo usuario de prueba.
            const lastEntry = null; // Simplificación para no complicar el renderizado con lógica de búsqueda compleja.
            const status = lastEntry && !lastEntry.clockOut ? 'IN' : 'OUT';
            const buttonText = status === 'IN' ? 'Registrar Salida (Clock Out)' : 'Registrar Entrada (Clock In)';
            const buttonColor = status === 'IN' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700';

            const employeeOptions = employeeList.map(e => `<option value="${e.id}">${e.name} (${branchList.find(b => b.id === e.branchId)?.name || 'Sin Sucursal'})</option>`).join('');

            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Registro de Tiempo</h2>

                <div class="card p-6 mb-6">
                    <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Empleado</label>
                    <select id="employee-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                        ${employeeOptions}
                    </select>

                    <div class="mt-6 text-center">
                        <button onclick="handleClockAction('${status}')"
                                class="clock-button w-full max-w-sm mx-auto text-white font-bold py-4 px-6 rounded-xl shadow-lg ${buttonColor} focus:outline-none focus:ring-4 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            <i data-lucide="${status === 'IN' ? 'log-out' : 'log-in'}" class="w-6 h-6 inline mr-2"></i>
                            ${buttonText}
                        </button>
                    </div>

                    <div id="status-message" class="mt-6 p-3 text-sm text-center bg-blue-50 text-blue-800 rounded-lg hidden">
                        Obteniendo ubicación... Por favor, espere.
                    </div>
                </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-3">Últimos Registros</h3>
                <div id="latest-entries" class="space-y-3">
                     <p class="text-gray-500">Los registros recientes se cargarán aquí (lógica no implementada para simplificar). Ver Reportes para todos los datos.</p>
                </div>
            `;
            lucide.createIcons();
        }

        /** Carga y prepara los datos para la vista de Reportes. */
        async function loadReportData() {
            try {
                const entries = await getAll('timeEntries');
                const employees = await getAll('employees');
                const branches = await getAll('branches');

                const employeeMap = new Map(employees.map(e => [e.id, e]));
                const branchMap = new Map(branches.map(b => [b.id, b]));

                // Filtrar entradas completadas para el cálculo de horas
                const completedEntries = entries.filter(e => e.clockOut);

                // Calcular horas trabajadas por empleado
                const hoursByEmployee = completedEntries.reduce((acc, entry) => {
                    const durationMs = entry.clockOut - entry.clockIn;
                    const durationHours = durationMs / (1000 * 60 * 60);
                    const employeeId = entry.employeeId;

                    acc[employeeId] = (acc[employeeId] || 0) + durationHours;
                    return acc;
                }, {});

                return { entries, hoursByEmployee, employeeMap, branchMap };

            } catch (error) {
                showMessage("Error al cargar datos para reportes.", 'error');
                console.error(error);
                return { entries: [], hoursByEmployee: {}, employeeMap: new Map(), branchMap: new Map() };
            }
        }

        /** Renderiza la vista de Reportes/Estadísticas. */
        function renderReportsView(reportData) {
            const contentArea = document.getElementById('content-area');
            const { entries, hoursByEmployee, employeeMap, branchMap } = reportData;

            let hoursSummaryHtml = '';
            if (Object.keys(hoursByEmployee).length > 0) {
                hoursSummaryHtml = Object.entries(hoursByEmployee).map(([id, hours]) => `
                    <li class="flex justify-between py-2 border-b last:border-b-0">
                        <span class="font-medium text-gray-700">${employeeMap.get(parseInt(id))?.name || `Empleado ID: ${id}`}</span>
                        <span class="font-bold text-indigo-600">${formatHours(hours)}</span>
                    </li>
                `).join('');
            } else {
                 hoursSummaryHtml = '<p class="text-gray-500">No hay entradas completadas para calcular horas.</p>';
            }


            let entryListHtml = entries.slice(-10).reverse().map(entry => { // Mostrar 10 más recientes
                const employee = employeeMap.get(entry.employeeId);
                const branch = branchMap.get(entry.branchId);
                const branchName = branch?.name || 'Desconocida';
                const employeeName = employee?.name || `ID: ${entry.employeeId}`;

                let distanceHtml = '';
                if (entry.clockOut && entry.inLat && branch?.lat) {
                    const distanceIn = getDistance(entry.inLat, entry.inLng, branch.lat, branch.lng);
                    const distanceOut = getDistance(entry.outLat, entry.outLng, branch.lat, branch.lng);
                    const statusClassIn = distanceIn > 100 ? 'text-red-500' : 'text-green-500'; // 100m de tolerancia
                    const statusClassOut = distanceOut > 100 ? 'text-red-500' : 'text-green-500';

                    distanceHtml = `
                        <p class="text-xs text-gray-500 mt-1">
                            Entrada: <span class="${statusClassIn}">${(distanceIn / 1000).toFixed(2)} km</span> |
                            Salida: <span class="${statusClassOut}">${(distanceOut / 1000).toFixed(2)} km</span>
                            (vs ${branchName})
                        </p>
                    `;
                }

                return `
                    <div class="card p-4 border-l-4 ${entry.clockOut ? 'border-green-400' : 'border-yellow-400'}">
                        <p class="font-bold text-gray-800">${employeeName}</p>
                        <p class="text-sm text-gray-600">
                            IN: ${new Date(entry.clockIn).toLocaleString()}
                        </p>
                        ${entry.clockOut ? `<p class="text-sm text-gray-600">OUT: ${new Date(entry.clockOut).toLocaleString()}</p>` : `<p class="text-sm text-yellow-600 font-semibold">Aún en turno</p>`}
                        ${distanceHtml}
                    </div>
                `;
            }).join('');


            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Reportes y Estadísticas</h2>

                <div class="card p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Horas Totales Trabajadas</h3>
                    <ul class="divide-y divide-gray-100">
                        ${hoursSummaryHtml}
                    </ul>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Historial de Registros (Últimos ${entries.length})</h3>
                    <div class="space-y-4">
                        ${entryListHtml || '<p class="text-gray-500">No hay registros de tiempo en la base de datos.</p>'}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        /** Renderiza la vista de Configuración y Ajustes. */
        function renderSetup() {
            return `
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Ajustes y Configuración</h2>

                <div class="space-y-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-blue-500"></i>
                            Administrar Sucursales (${branchList.length})
                        </h3>
                        <form id="branch-form" class="space-y-3 mb-6">
                            <input type="text" id="branch-name" placeholder="Nombre de Sucursal" class="w-full border-gray-300 rounded-lg p-3">
                            <div class="flex space-x-2">
                                <input type="number" step="0.000001" id="branch-lat" placeholder="Latitud (Ej: 19.43)" class="w-1/2 border-gray-300 rounded-lg p-3">
                                <input type="number" step="0.000001" id="branch-lng" placeholder="Longitud (Ej: -99.13)" class="w-1/2 border-gray-300 rounded-lg p-3">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Agregar Sucursal
                            </button>
                        </form>
                        <ul id="branch-list" class="divide-y divide-gray-200">
                            </ul>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2 text-indigo-500"></i>
                            Administrar Empleados (${employeeList.length})
                        </h3>
                         <form id="employee-form" class="space-y-3 mb-6">
                            <input type="text" id="employee-name" placeholder="Nombre Completo del Empleado" class="w-full border-gray-300 rounded-lg p-3">
                            <select id="employee-branch-id" class="w-full border-gray-300 rounded-lg p-3">
                                <option value="">Selecciona Sucursal Asignada</option>
                                ${branchList.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                            </select>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">
                                <i data-lucide="user-plus" class="w-4 h-4 inline mr-1"></i> Agregar Empleado
                            </button>
                        </form>
                        <ul id="employee-list" class="divide-y divide-gray-200">
                            </ul>
                    </div>
         <div class="card p-6 bg-gray-100 border-l-4 border-gray-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="git-branch" class="w-5 h-5 mr-2 text-gray-600"></i>
                            Sincronización (GitHub Gist)
                        </h3>
                        <p class="text-sm text-gray-600 mb-3">Utiliza un <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-500 hover:underline">Token Personal de GitHub</a> con permiso 'gist'.</p>

                        <label for="gist-token" class="block text-sm font-medium text-gray-700 mt-4">Token de Acceso Personal de GitHub</label>
                        <input type="password" id="gist-token" placeholder="ghp_XXXXXXXXXXXXXXXXXXXX" class="w-full border-gray-300 rounded-lg p-3 mt-1">

                        <label for="gist-id" class="block text-sm font-medium text-gray-700 mt-3">ID del Gist (Opcional para actualizar)</label>
                        <input type="text" id="gist-id" placeholder="Ej: a1b2c3d4e5f6g7h8i9j0" class="w-full border-gray-300 rounded-lg p-3 mt-1">

                        <div class="flex space-x-3 mt-6">
                            <button onclick="handleGistExport()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition disabled:opacity-50" id="export-btn">
                                <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i> Exportar
                            </button>
                            <button onclick="handleGistImport()" class="flex-1 bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-700 transition disabled:opacity-50" id="import-btn">
                                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Importar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ======================== MANEJADORES DE VISTA ========================

        /** Inicializa y actualiza las listas de Sucursales y Empleados */
        async function refreshSetupLists() {
            branchList = await getAll('branches');
            employeeList = await getAll('employees');

            if (currentView !== 'setup') return;

            // 1. Renderizar Sucursales
            const branchListEl = document.getElementById('branch-list');
            if (branchListEl) {
                branchListEl.innerHTML = branchList.map(b => `
                    <li class="p-3 flex justify-between items-center text-gray-700">
                        <span>${b.name} <span class="text-xs text-gray-500 ml-2">(${b.lat.toFixed(4)}, ${b.lng.toFixed(4)})</span></span>
                        <button onclick="removeStoreItem('branches', ${b.id})" class="text-red-500 hover:text-red-700 transition">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </li>
                `).join('');
            }

            // 2. Renderizar Empleados
            const employeeListEl = document.getElementById('employee-list');
            const branchSelectEl = document.getElementById('employee-branch-id');

            if (branchSelectEl) {
                 branchSelectEl.innerHTML = `<option value="">Selecciona Sucursal Asignada</option>` +
                    branchList.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            }

            if (employeeListEl) {
                employeeListEl.innerHTML = employeeList.map(e => {
                    const branch = branchList.find(b => b.id === e.branchId);
                    return `
                        <li class="p-3 flex justify-between items-center text-gray-700">
                            <span>${e.name} <span class="text-xs text-indigo-500 ml-2">(${branch?.name || 'Sin asignar'})</span></span>
                            <button onclick="removeStoreItem('employees', ${e.id})" class="text-red-500 hover:text-red-700 transition">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </li>
                    `;
                }).join('');
            }
            lucide.createIcons();
        }

        /**
         * Maneja el registro de entrada/salida de un empleado.
         * @param {'IN'|'OUT'} status El estado actual del botón (se registrará lo opuesto).
         */
        async function handleClockAction(status) {
            const employeeId = parseInt(document.getElementById('employee-select').value);
            const employee = employeeList.find(e => e.id === employeeId);
            const messageEl = document.getElementById('status-message');

            if (!employee) {
                showMessage("Por favor, seleccione un empleado válido.", 'error');
                return;
            }
            if (!employee.branchId) {
                showMessage("El empleado no tiene una sucursal asignada. Asigne una en Ajustes.", 'error');
                return;
            }

            messageEl.textContent = 'Obteniendo ubicación... Por favor, espere.';
            messageEl.classList.remove('hidden');

            try {
                const location = await getCurrentLocation();
                messageEl.classList.add('hidden');
                let entry;

                if (status === 'OUT') {
                    // Acción: CLOCK IN (Crear nueva entrada)
                    entry = {
                        employeeId: employeeId,
                        branchId: employee.branchId,
                        clockIn: Date.now(),
                        clockOut: null,
                        inLat: location.lat,
                        inLng: location.lng,
                        outLat: null,
                        outLng: null,
                        status: 'IN'
                    };
                    await put('timeEntries', entry);
                    showMessage(`Entrada registrada para ${employee.name}. ¡Comenzó el turno!`, 'success');
                } else {
                    // Acción: CLOCK OUT (Actualizar última entrada)
                    const entries = await getAll('timeEntries');
                    // Simulación: encontrar la última entrada abierta de este empleado
                    const openEntry = entries
                        .filter(e => e.employeeId === employeeId && !e.clockOut)
                        .pop(); // Última entrada no completada

                    if (!openEntry) {
                        showMessage("No se encontró una entrada abierta para registrar la salida.", 'error');
                        return;
                    }

                    openEntry.clockOut = Date.now();
                    openEntry.outLat = location.lat;
                    openEntry.outLng = location.lng;
                    openEntry.status = 'OUT';

                    await put('timeEntries', openEntry);
                    showMessage(`Salida registrada para ${employee.name}. Turno finalizado.`, 'success');
                }

                // Recargar vista para actualizar el botón de estado
                showView('track');

            } catch (error) {
                messageEl.classList.add('hidden');
                showMessage(`Error al registrar: ${error.message}`, 'error');
            }
        }

        // ======================== MANEJADORES DE FORMULARIOS ========================

        /** * FIX: Configura los manejadores de eventos después de renderizar 'setup'. 
         * Se llama directamente desde showView.
         */
        function setupFormListeners() {
            // 1. Asegurarse de que las listas y el select de empleados estén cargados y actualizados.
            refreshSetupLists();

            // 2. Adjuntar listener de Sucursal
            document.getElementById('branch-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('branch-name').value.trim();
                const lat = parseFloat(document.getElementById('branch-lat').value);
                const lng = parseFloat(document.getElementById('branch-lng').value);

                if (name && !isNaN(lat) && !isNaN(lng)) {
                    await put('branches', { name, lat, lng });
                    document.getElementById('branch-form').reset();
                    await refreshSetupLists();
                    showMessage(`Sucursal '${name}' agregada.`, 'success');
                } else {
                    showMessage("Todos los campos de Sucursal son obligatorios y válidos.", 'error');
                }
            });

            // 3. Adjuntar listener de Empleado
            document.getElementById('employee-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('employee-name').value.trim();
                const branchId = parseInt(document.getElementById('employee-branch-id').value);

                if (name && branchId) {
                    const branch = branchList.find(b => b.id === branchId);
                    await put('employees', { name, branchId, profileData: {}, branchName: branch.name });
                    document.getElementById('employee-form').reset();
                    await refreshSetupLists();
                    showMessage(`Empleado '${name}' agregado y asignado.`, 'success');
                } else {
                    showMessage("El Nombre del Empleado y la Sucursal son obligatorios.", 'error');
                }
            });
        }
/** Elimina un elemento de la base de datos y refresca la vista. */
        async function removeStoreItem(storeName, id) {
            try {
                // FIX: La función remove ya se encarga de convertir el id a número con el Dexie Manager.
                await remove(storeName, id);
                await refreshSetupLists();
                showMessage(`Elemento eliminado de '${storeName}'.`, 'success');
            } catch (error) {
                showMessage("Error al eliminar el elemento.", 'error');
                console.error(error);
            }
        }

        /** Maneja el proceso de Exportación a Gist. */
        async function handleGistExport() {
            const token = document.getElementById('gist-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim() || null;
            const exportBtn = document.getElementById('export-btn');
            if (!token) {
                showMessage("El Token de GitHub es obligatorio para exportar.", 'error');
                return;
            }

            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i> Exportando...';

            try {
                const newGistId = await exportToGist(token, gistId);
                document.getElementById('gist-id').value = newGistId;
                showMessage(`Datos exportados con éxito. Gist ID: ${newGistId}`, 'success');
            } catch (error) {
                showMessage(`Fallo al exportar: ${error.message}`, 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i data-lucide="upload" class="w-4 h-4 inline mr-1"></i> Exportar';
                lucide.createIcons();
            }
        }

        /** Maneja el proceso de Importación desde Gist. */
        async function handleGistImport() {
            const token = document.getElementById('gist-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim();
            const importBtn = document.getElementById('import-btn');

            if (!token || !gistId) {
                showMessage("El Token y el Gist ID son obligatorios para importar.", 'error');
                return;
            }

            importBtn.disabled = true;
            importBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i> Importando...';

            try {
                await importFromGist(token, gistId);
                // Una vez importado, recargar todos los datos y la vista
                await refreshSetupLists();
                showMessage("Datos importados con éxito. Base de datos actualizada.", 'success');
                showView('dashboard');
            } catch (error) {
                showMessage(`Fallo al importar: ${error.message}`, 'error');
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = '<i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Importar';
                lucide.createIcons();
            }
        }


        /**
         * FIX: Función de inicio de la aplicación, ahora llamada inmediatamente.
         */
        window.initApp = async function() {
            try {
                await initDB();
                await refreshSetupLists(); // Cargar datos iniciales
                showView('dashboard'); // Mostrar la vista inicial
            } catch (error) {
                showMessage("Fallo crítico al iniciar la aplicación. Ver consola.", 'error');
                console.error("App initialization failed:", error);
            }
        };

        // Renderiza los iconos de la cabecera antes de initApp (si ya cargaron)
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        // Llamada de inicio inmediata (Sustituye la espera de Firebase)
        window.initApp();

    </script>
</body>
</html>
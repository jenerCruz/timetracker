<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicMe Tracker PWA (Consolidado)</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración para usar la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html { font-family: 'Inter', sans-serif; }
    </style>
    
    <!-- Carga de Lucide Icons (Iconos) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Carga de Dexie (IndexedDB) -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

    <!-- 
        =======================================================================
        ESTILOS CONSOLIDADOS (styles.css) 
        =======================================================================
    -->
    <style>
        :root {
            --primary-color: #1e3a8a; /* Indigo 800 */
            --accent-color: #3b82f6;  /* Blue 500 */
        }
        body {
            background-color: #f8f9fa; /* Light Gray background */
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
        }
        .nav-icon {
            transition: color 0.2s, transform 0.2s;
        }
        .nav-icon.active {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        /* Estilo tipo card */
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        /* Animación para el botón principal de Clock In/Out */
        .clock-button {
            transition: all 0.3s ease;
        }
        .clock-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgba(59, 130, 246, 0.4);
        }
        /* Estilo para los inputs */
        input:focus, select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* Estilos para la gráfica de barras simple */
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .bar {
            height: 1.5rem; /* 6 */
            border-radius: 0.25rem; /* rounded-md */
            transition: width 0.5s ease;
            background-color: #3b82f6; /* Blue 500 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="app-container max-w-4xl mx-auto shadow-2xl bg-white">
        <!-- Encabezado Fijo -->
        <header class="p-4 border-b bg-white sticky top-0 z-10">
            <h1 class="text-2xl font-extrabold text-gray-800 flex items-center">
                <i data-lucide="clock" class="w-6 h-6 mr-2 text-indigo-700"></i>
                Time Tracker Pro
            </h1>
            <p id="user-id-display" class="text-xs mt-1 text-gray-500 truncate">ID de Usuario: Cargando...</p>
        </header>

        <!-- Contenido Principal Dinámico -->
        <main id="content-area" class="main-content p-4 sm:p-6 pb-20 overflow-y-auto">
            <!-- Contenido de Carga Inicial -->
            <div class="text-center py-10 text-gray-500">
                <i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin"></i>
                <p class="mt-2">Cargando aplicación...</p>
            </div>
        </main>

        <!-- Navegación Fija Inferior (Mobile-First) -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl z-20 sm:hidden">
            <div class="flex justify-around items-center h-16">
                <!-- Los eventos onclick llaman a funciones globales de la app -->
                <button onclick="window.showView('dashboard')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 nav-icon active" data-view="dashboard"></i>
                    <span class="text-xs mt-1 font-medium">Inicio</span>
                </button>
                <button onclick="window.showView('track')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="clock-3" class="w-6 h-6 nav-icon" data-view="track"></i>
                    <span class="text-xs mt-1 font-medium">Registro</span>
                </button>
                <button onclick="window.showView('reports')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 nav-icon" data-view="reports"></i>
                    <span class="text-xs mt-1 font-medium">Reportes</span>
                </button>
                <button onclick="window.showView('setup')" class="flex flex-col items-center p-2 text-gray-500 hover:text-blue-500">
                    <i data-lucide="settings" class="w-6 h-6 nav-icon" data-view="setup"></i>
                    <span class="text-xs mt-1 font-medium">Ajustes</span>
                </button>
            </div>
        </nav>

        <!-- Contenedor de Mensajes Modales/Notificaciones -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        </div>

    </div>
    
    <!-- 
        =======================================================================
        LÓGICA CONSOLIDADA (app.js) 
        =======================================================================
    -->
    <script>
        // Inicio de la Expresión de Función Ejecutada Inmediatamente (IIFE)
        (function () {
            
            // =========================================================================
            // CONFIGURACIÓN GLOBAL Y UTILIDADES
            // =========================================================================
            const DB_NAME = 'TimeTrackerDB';
            const DB_VERSION = 1;
            // Generación de ID de usuario para Dexie
            const userId = 'anon-' + (localStorage.getItem('anonId') || crypto.randomUUID());
            localStorage.setItem('anonId', userId);
            
            let db; 
            let currentView = 'dashboard';
            let branchList = [];
            let employeeList = [];

            // --- UTILIDADES GLOBALES ---
            
            /** Convierte milisegundos a horas y minutos legibles. */
            function msToHms(ms) {
                if (ms < 0 || !ms) return "0h 0m";
                const seconds = Math.floor(ms / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            }

            function deg2rad(deg) {
                return deg * (Math.PI / 180);
            }

            /** Calcula la distancia en metros (Fórmula Haversine) */
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const dLat = deg2rad(lat2 - lat1);
                const dLon = deg2rad(lon2 - lon1);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; 
            }

            /** Muestra un mensaje modal de forma segura. */
            function showMessage(message, type = 'info') {
                const container = document.getElementById('modal-container');
                let bgColor = 'bg-blue-600';
                let icon = 'info';

                if (type === 'error') {
                    bgColor = 'bg-red-600';
                    icon = 'alert-triangle';
                } else if (type === 'success') {
                    bgColor = 'bg-green-600';
                    icon = 'check-circle';
                }

                const modalHtml = `
                    <div class="card p-6 w-full max-w-sm mx-auto transform transition-all scale-100 duration-300">
                        <div class="flex items-center space-x-4">
                            <i data-lucide="${icon}" class="w-6 h-6 text-white ${bgColor} rounded-full p-1 flex-shrink-0"></i>
                            <p class="text-gray-700 font-semibold flex-grow">${message}</p>
                        </div>
                        <div class="mt-4 text-right">
                            <button onclick="window.hideMessage()" class="px-4 py-2 text-sm font-medium rounded-lg text-white ${bgColor} hover:opacity-90">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;

                container.innerHTML = modalHtml;
                container.classList.remove('hidden');
                container.classList.add('flex');
                lucide.createIcons();

                setTimeout(hideMessage, 5000); 
            }

            /** Oculta el modal de mensajes. */
            function hideMessage() {
                document.getElementById('modal-container').classList.add('hidden');
                document.getElementById('modal-container').classList.remove('flex');
            }

            /** Obtiene la ubicación actual del usuario (Funcional con Fallback). */
            function getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.getCurrentPosition(position => {
                            resolve({ lat: position.coords.latitude, lng: position.coords.longitude });
                        }, error => {
                            console.error("Geolocation error:", error);
                            showMessage("Error de Geolocalización. Usando ubicación de fallback (0,0).", 'error');
                            // Fallback para evitar bloqueo de la app
                            resolve({ lat: 0, lng: 0 }); 
                        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
                    } else {
                        console.warn("Geolocation no soportada. Usando ubicación de fallback (0,0).");
                        resolve({ lat: 0, lng: 0 }); // Fallback
                    }
                });
            }
 // =========================================================================
            // DEXIE MANAGER (IndexedDB)
            // =========================================================================

            /** Inicializa la base de datos con Dexie. */
            function initDB() {
                return new Promise((resolve, reject) => {
                    try {
                        db = new Dexie(DB_NAME); 
                        db.version(DB_VERSION).stores({
                            branches: '++id, name',
                            employees: '++id, branchId',
                            timeEntries: '++id, employeeId, clockIn'
                        });

                        db.open().then(() => resolve(db)).catch(err => {
                            console.error("Error al abrir Dexie:", err);
                            showMessage(`Error de base de datos: ${err.message}`, 'error');
                            reject(err);
                        });
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            async function getAll(storeName) {
                return db.table(storeName).toArray();
            }

            async function put(storeName, item) {
                return db.table(storeName).put(item);
            }

            async function remove(storeName, id) {
                // Asegúrate de que id sea un número para la eliminación en Dexie
                return db.table(storeName).delete(parseInt(id));
            }


            // =========================================================================
            // LÓGICA DE VISTAS Y MANEJADORES
            // =========================================================================

            /** Cambia la vista activa y actualiza los íconos de navegación. */
            function showView(viewName) {
                currentView = viewName;
                const contentArea = document.getElementById('content-area');
                
                // Muestra un loader mientras se renderiza la vista
                contentArea.innerHTML = `<div class="text-center py-10 text-gray-500"><i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin"></i><p class="mt-2">Cargando contenido...</p></div>`;
                lucide.createIcons();

                // Carga la vista dinámicamente
                switch (viewName) {
                    case 'dashboard':
                        loadDashboardData().then(renderDashboard).catch(e => {
                            contentArea.innerHTML = `<div class="p-6 text-center card bg-red-100 text-red-800">Error al cargar dashboard: ${e.message}</div>`;
                            console.error(e);
                        });
                        break;
                    case 'track':
                        loadTrackData().then(renderTrackView).catch(console.error);
                        break;
                    case 'reports':
                        loadReportData().then(renderReportsView).catch(console.error);
                        break;
                    case 'setup':
                        contentArea.innerHTML = renderSetup(branchList, employeeList);
                        setupFormListeners();
                        break;
                    default:
                        loadDashboardData().then(renderDashboard).catch(console.error);
                }

                updateNavIcons(viewName);
            }

            /** Actualiza el estilo del ícono de navegación activo. */
            function updateNavIcons(viewName) {
                document.querySelectorAll('.nav-icon').forEach(icon => {
                    const iconView = icon.getAttribute('data-view');
                    const button = icon.closest('button');
                    
                    if (!button) return;

                    if (iconView === viewName) {
                        icon.classList.add('active');
                        button.classList.add('text-blue-500');
                        button.classList.remove('text-gray-500');
                    } else {
                        icon.classList.remove('active');
                        button.classList.remove('text-blue-500');
                        button.classList.add('text-gray-500');
                    }
                });
            }

            // ------------------ Vista Dashboard (MEJORADA) ------------------
            
            /** Carga y procesa los datos para el Dashboard. */
            async function loadDashboardData() {
                const employees = await getAll('employees');
                const entries = await getAll('timeEntries');
                
                const now = Date.now();
                const yesterday = now - (24 * 60 * 60 * 1000); 

                let totalWorkMs = 0;
                const employeeHours = {}; // { employeeId: totalMs }
                const activeEmployees = [];
                
                // Inicializar horas y encontrar activos
                employees.forEach(e => {
                    employeeHours[e.id] = 0;
                });
                
                entries.forEach(entry => {
                    // 1. Calcular horas trabajadas
                    if (entry.clockIn && entry.clockOut) {
                        const duration = entry.clockOut - entry.clockIn;
                        totalWorkMs += duration;
                        employeeHours[entry.employeeId] += duration;
                    }
                    
                    // 2. Encontrar empleados activos
                    if (entry.clockIn >= yesterday && entry.clockOut === null) {
                        if (!activeEmployees.includes(entry.employeeId)) {
                             activeEmployees.push(entry.employeeId);
                        }
                    }
                });
                
                // Convertir y calcular máximo para la gráfica
                let maxHoursMs = 0;
                const employeeStats = employees.map(e => {
                    const totalMs = employeeHours[e.id] || 0;
                    if (totalMs > maxHoursMs) maxHoursMs = totalMs;
                    return {
                        id: e.id,
                        name: e.name,
                        totalMs: totalMs,
                        totalHms: msToHms(totalMs)
                    };
                });


                return {
                    totalEmployees: employees.length,
                    activeEmployeesCount: activeEmployees.length,
                    totalTime: msToHms(totalWorkMs),
                    employeeStats,
                    maxHoursMs,
                };
            }

            /** Renderiza el Dashboard con las estadísticas. */
            function renderDashboard(data) {
                const contentArea = document.getElementById('content-area');
                
                // --- Generar Gráfica de Barras ---
                const maxBarWidth = 100; // Porcentaje máximo
                
                const barHtml = data.employeeStats.sort((a, b) => b.totalMs - a.totalMs).map(stat => {
                    const widthPercent = data.maxHoursMs > 0 ? (stat.totalMs / data.maxHoursMs) * maxBarWidth : 0;
                    
                    return `
                        <div class="bar-container">
                            <span class="w-1/4 text-sm font-medium text-gray-700 truncate">${stat.name}:</span>
                            <div class="w-3/4 flex items-center">
                                <div class="bar flex-grow bg-blue-500 mr-2" style="width: ${widthPercent.toFixed(2)}%"></div>
                                <span class="text-xs font-semibold text-gray-600">${stat.totalHms}</span>
                            </div>
                        </div>
                    `;
                }).join('');


                contentArea.innerHTML = `
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h2>
                    
                    <!-- Tarjetas de Resumen (Key Metrics) -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                        
                        <div class="card p-4 bg-indigo-50 border-l-4 border-indigo-500">
                            <i data-lucide="users" class="w-6 h-6 text-indigo-500 mb-2"></i>
                            <p class="text-sm font-medium text-gray-500">Empleados Totales</p>
                            <p class="text-2xl font-bold text-gray-800">${data.totalEmployees}</p>
                        </div>

                        <div class="card p-4 bg-green-50 border-l-4 border-green-500">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-500 mb-2"></i>
                            <p class="text-sm font-medium text-gray-500">Empleados Activos</p>
                            <p class="text-2xl font-bold text-gray-800">${data.activeEmployeesCount}</p>
                        </div>
                        
                        <div class="card p-4 bg-yellow-50 border-l-4 border-yellow-500">
                            <i data-lucide="clock-4" class="w-6 h-6 text-yellow-500 mb-2"></i>
                            <p class="text-sm font-medium text-gray-500">Total Horas Registradas</p>
                            <p class="text-2xl font-bold text-gray-800">${data.totalTime}</p>
                        </div>
                    </div>
                    
                    <!-- Histograma de Horas por Empleado -->
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-blue-600"></i>
                            Horas Totales por Empleado
                        </h3>
                        
                        ${data.totalEmployees === 0 
                            ? '<p class="text-gray-500">No hay empleados ni registros. ¡Comienza en Ajustes!</p>'
                            : `<div class="space-y-3">${barHtml}</div>`
                        }
                    </div>
                `;
                lucide.createIcons();
            }
            
            // ------------------ Vista Checado (Track) ------------------

            async function loadTrackData() {
                try {
                    const branches = await getAll('branches');
                    const employees = await getAll('employees');
                    branchList = branches;
                    employeeList = employees;
                    return { branches, employees };
                } catch (error) {
                    showMessage("Error al cargar datos de Sucursales/Empleados.", 'error');
                    console.error(error);
                    return { branches: [], employees: [] };
                }
            }

            async function renderTrackView({ branches, employees }) {
                const contentArea = document.getElementById('content-area');

                if (employees.length === 0) {
                    contentArea.innerHTML = `<div class="p-6 text-center card bg-yellow-100 border-yellow-400 border"><p class="font-semibold text-yellow-800">No hay empleados registrados. Por favor, agregue perfiles en la sección Ajustes.</p></div>`;
                    lucide.createIcons();
                    return;
                }
                
                const employeeOptions = employees.map(e => `<option value="${e.id}">${e.name} (${branches.find(b => b.id === e.branchId)?.name || 'Sin Sucursal'})</option>`).join('');

                const lastEntries = await db.timeEntries.reverse().limit(5).toArray();
                const employeeMap = new Map(employees.map(e => [e.id, e.name]));

                const latestEntriesHtml = lastEntries.map(entry => {
                    const status = entry.clockOut ? 'Finalizado' : 'En turno';
                    const statusColor = entry.clockOut ? 'text-green-600' : 'text-yellow-600 font-semibold';
                    const employeeName = employeeMap.get(entry.employeeId) || 'Desconocido';
                    const timeIn = new Date(entry.clockIn).toLocaleTimeString();
                    const timeOut = entry.clockOut ? new Date(entry.clockOut).toLocaleTimeString() : 'N/A';
                    
                    return `
                        <div class="card p-3 border-l-4 ${entry.clockOut ? 'border-green-400' : 'border-yellow-400'}">
                            <p class="font-bold text-gray-800">${employeeName}</p>
                            <p class="text-sm text-gray-600">IN: ${timeIn} | OUT: ${timeOut} </p>
                            <p class="text-sm ${statusColor}">${status}</p>
                        </div>
                    `;
                }).join('');


                contentArea.innerHTML = `
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Registro de Tiempo</h2>

                    <div class="card p-6 mb-6">
                        <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Empleado</label>
                        <select id="employee-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                            ${employeeOptions}
                        </select>

                        <div class="mt-6 text-center">
                            <button onclick="window.handleClockAction('OUT')"
                                    class="clock-button w-full max-w-sm mx-auto text-white font-bold py-4 px-6 rounded-xl shadow-lg bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-opacity-50 transition duration-150 ease-in-out">
                                <i data-lucide="log-in" class="w-6 h-6 inline mr-2"></i>
                                Registrar Entrada (Clock In)
                            </button>
                        </div>

                        <div id="status-message" class="mt-6 p-3 text-sm text-center bg-blue-50 text-blue-800 rounded-lg hidden">
                            Obteniendo ubicación... Por favor, espere.
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Últimos Registros (Globales)</h3>
                    <div id="latest-entries" class="space-y-3">
                         ${latestEntriesHtml || '<p class="text-gray-500">No hay registros de tiempo.</p>'}
                    </div>
                `;
                lucide.createIcons();
                updateClockButtonState();
            }

            /** Actualiza el estado del botón Clock In/Out según el empleado seleccionado. */
            async function updateClockButtonState() {
                const $select = document.getElementById('employee-select');
                const $button = document.querySelector('.clock-button');
                
                if (!$select || !$button) return;

                const employeeId = parseInt($select.value);
                
                const openEntry = await db.timeEntries
                    .where('employeeId').equals(employeeId)
                    .and(entry => entry.clockOut === null || entry.clockOut === undefined)
                    .last(); 
                
                // Si hay entrada abierta (openEntry), la siguiente acción es IN (para Clock Out)
                const status = openEntry ? 'IN' : 'OUT'; 
                const buttonText = status === 'IN' ? 'Registrar Salida (Clock Out)' : 'Registrar Entrada (Clock In)';
                const buttonColor = status === 'IN' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700';
                const buttonIcon = status === 'IN' ? 'log-out' : 'log-in';

                $button.setAttribute('onclick', `window.handleClockAction('${status}')`);
                $button.className = `clock-button w-full max-w-sm mx-auto text-white font-bold py-4 px-6 rounded-xl shadow-lg ${buttonColor} focus:outline-none focus:ring-4 focus:ring-opacity-50 transition duration-150 ease-in-out`;
                $button.innerHTML = `<i data-lucide="${buttonIcon}" class="w-6 h-6 inline mr-2"></i> ${buttonText}`;
                lucide.createIcons();

                $select.onchange = updateClockButtonState;
            }

            /** Maneja el registro de entrada/salida de un empleado (Checado). */
            async function handleClockAction(status) {
                const employeeId = parseInt(document.getElementById('employee-select').value);
                const employee = employeeList.find(e => e.id === employeeId);
                const messageEl = document.getElementById('status-message');

                if (!employee) {
                    showMessage("Empleado no seleccionado.", 'error');
                    return;
                }
                
                messageEl.textContent = 'Obteniendo ubicación... Por favor, espere.';
                messageEl.classList.remove('hidden');

                try {
                    const location = await getCurrentLocation();
                    messageEl.classList.add('hidden');

                    const branch = branchList.find(b => b.id === employee.branchId);
                    const geocercaRadio = 100; // 100 metros por defecto

                    if (branch && branch.lat != null && branch.lng != null) {
                        const distance = getDistance(location.lat, location.lng, branch.lat, branch.lng);
                        
                        if (distance > geocercaRadio) {
                            // Alerta de Geolocalización.
                            showMessage(`Ubicación fuera de geocerca (Sucursal ${branch.name}). Distancia: ${distance.toFixed(2)}m.`, 'error');
                        }
                    }

                    if (status === 'OUT') {
                        // Acción: CLOCK IN
                        const entry = {
                            employeeId: employeeId,
                            branchId: employee.branchId,
                            clockIn: Date.now(),
                            inLat: location.lat,
                            inLng: location.lng,
                            clockOut: null, 
                        };
                        await put('timeEntries', entry);
                        showMessage(`Entrada registrada para ${employee.name}.`, 'success');
                    } else {
                        // Acción: CLOCK OUT
                        const openEntry = await db.timeEntries
                            .where('employeeId').equals(employeeId)
                            .and(entry => entry.clockOut === null || entry.clockOut === undefined)
                            .last(); 

                        if (!openEntry) {
                            showMessage("No se encontró una entrada abierta para registrar la salida.", 'error');
                            return;
                        }

                        openEntry.clockOut = Date.now();
                        openEntry.outLat = location.lat;
                        openEntry.outLng = location.lng;

                        await put('timeEntries', openEntry);
                        showMessage(`Salida registrada para ${employee.name}.`, 'success');
                    }

                    showView('track'); // Refrescar la vista de registro

                } catch (error) {
                    messageEl.classList.add('hidden');
                    showMessage(`Error al registrar: ${error.message}`, 'error');
                }
            }
            
            // ------------------ Vista Reportes ------------------

            async function loadReportData